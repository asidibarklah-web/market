<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oubrou Market</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = { theme: { extend: { colors: { primary: '#4f46e5' }}}}
</script>
<style>
.product-card { transition: transform 0.2s ease, box-shadow 0.2s ease; transform-style: preserve-3d; }
.product-card:hover { box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
</style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">

<!-- HEADER -->
<header class="bg-white border-b sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <div class="flex items-center gap-4">
      <div class="bg-primary text-white p-3 rounded-xl shadow">üè™</div>
      <div>
        <h1 class="font-bold text-xl">Oubrou Market</h1>
        <p class="text-sm text-gray-500">Professional Market System</p>
      </div>
    </div>
    <nav class="flex items-center gap-6">
      <button onclick="showShop()" class="font-medium hover:text-primary">Shop</button>
      <button onclick="showLogin()" class="font-medium hover:text-primary">Admin</button>
      <button onclick="openCart()" class="relative bg-primary text-white px-4 py-2 rounded-xl shadow">Cart
        <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-xs w-5 h-5 rounded-full flex items-center justify-center">0</span>
      </button>
    </nav>
  </div>
</header>

<!-- SHOP -->
<section id="shopPage" class="max-w-7xl mx-auto px-6 py-12">
  <h2 class="text-2xl font-bold mb-6">Products</h2>
  <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
</section>

<!-- LOGIN PAGE -->
<section id="loginPage" class="max-w-2xl mx-auto px-6 py-12 hidden">
  <div class="bg-white rounded-2xl shadow p-8 flex flex-col items-center">
    <h3 class="text-2xl font-bold mb-4">Admin Login</h3>
    <div class="relative w-full mb-3">
      <input id="adminPasswordInput" type="password" placeholder="Enter password" class="border rounded p-2 w-full pr-10">
      <button id="togglePassword" type="button" class="absolute right-2 top-2 text-gray-500 hover:text-gray-800">üëÅ</button>
    </div>
    <p id="loginError" class="text-red-600 mb-3 hidden">Wrong password!</p>
    <button onclick="loginAdmin()" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-indigo-600 transition">Enter</button>
  </div>
</section>

<!-- ADMIN -->
<section id="adminPage" class="hidden max-w-7xl mx-auto px-6 py-12">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold">Admin Dashboard</h2>
    <button onclick="logoutAdmin()" class="text-primary font-semibold hover:underline">Logout</button>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="bg-white rounded-2xl shadow p-6">
      <h3 class="font-semibold text-lg mb-4">Add / Edit Product</h3>
      <input id="pName" placeholder="Name" class="border rounded p-2 w-full mb-2">
      <input id="pPrice" type="number" placeholder="Price (DH)" class="border rounded p-2 w-full mb-2">
      <input id="pStock" type="number" placeholder="Current stock" class="border rounded p-2 w-full mb-2">
      <input id="pCapacity" type="number" placeholder="Total capacity" class="border rounded p-2 w-full mb-2">
      <input id="pProduction" type="date" placeholder="Production Date" class="border rounded p-2 w-full mb-2">
      <input id="pExpiration" type="date" placeholder="Expiration Date" class="border rounded p-2 w-full mb-3">
      <input id="pImage" placeholder="Image URL" class="border rounded p-2 w-full mb-3">
      <button onclick="saveProduct()" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-indigo-600 transition">Save Product</button>
      <input type="hidden" id="editIndex">
    </div>
  </div>

  <div class="bg-white rounded-2xl shadow p-6">
    <h3 class="text-lg font-semibold mb-4">Product List</h3>
    <div id="adminProductsList" class="space-y-4"></div>
  </div>
</section>

<!-- CART -->
<div id="cartPanel" class="fixed top-0 right-0 h-full w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50">
  <div class="p-6 flex flex-col h-full">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold">üõí Your Cart</h3>
      <button onclick="closeCart()" class="text-gray-500 hover:text-gray-800 text-xl">‚úï</button>
    </div>
    <div class="flex-1 overflow-y-auto space-y-4">
      <div id="cartItems" class="flex flex-col gap-3"></div>
    </div>
    <div class="border-t pt-4">
      <div class="flex justify-between font-bold text-lg mb-4"><span>Total</span><span id="cartTotal">0 DH</span></div>
      <button onclick="checkout()" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-indigo-600 transition">Checkout</button>
    </div>
  </div>
</div>

<!-- CHECKOUT -->
<section id="checkoutPage" class="hidden max-w-2xl mx-auto px-6 py-12">
  <h2 class="text-2xl font-bold mb-6">Checkout</h2>
  <div class="bg-white rounded-2xl shadow p-6 flex flex-col items-center">
    <p class="mb-6 text-gray-700">You're about to confirm your order.</p>
    <button onclick="confirmOrder()" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-indigo-600 transition">Confirm Order</button>
  </div>
</section>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-analytics.js";

const firebaseConfig = {
  apiKey: "AIzaSyABCrx6YzrWtLbHPpQL97GkGu2SCU5MdPw",
  authDomain: "oubrou-market.firebaseapp.com",
  projectId: "oubrou-market",
  storageBucket: "oubrou-market.firebasestorage.app",
  messagingSenderId: "593090931508",
  appId: "1:593090931508:web:3708017c3849be95109361",
  measurementId: "G-W8QJ3TYXWK"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);
const productsCollection = collection(db, "products");

let products = [];
let cart = [];
const ADMIN_PASSWORD = "Oubrou12345";
let adminUnlocked = false;

// DOM
const adminPasswordInput = document.getElementById("adminPasswordInput");
const togglePassword = document.getElementById("togglePassword");
const loginError = document.getElementById("loginError");

// FUNCTIONS
async function loadProducts() {
  products = [];
  const snapshot = await getDocs(productsCollection);
  snapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));
  renderProducts(); renderAdmin(); updateCartCount(); initFloatingEffect();
}

function renderProducts() {
  productList.innerHTML='';
  products.forEach((p,i)=>{
    const stockPercent = Math.min(100, (p.stock/p.capacity)*100);
    productList.innerHTML+=`
    <div class='product-card bg-white rounded-2xl shadow p-6 flex flex-col items-center'>
      <img src='${p.image}' class='h-40 w-40 object-cover rounded-lg mb-3'>
      <h4 class='font-semibold mt-2'>${p.name}</h4>
      <p class='text-gray-600 mb-1'>${p.price} DH</p>
      <div class="w-full bg-gray-200 rounded-full h-3 mb-1">
        <div class="bg-primary h-3 rounded-full transition-all" style="width:${stockPercent}%"></div>
      </div>
      <p class="text-sm text-gray-500 mb-2">Stock: ${p.stock} / ${p.capacity}</p>
      <button onclick='addToCart(${i})' class='mt-2 w-full bg-primary text-white py-2 rounded-lg hover:bg-indigo-600 transition'>Add to cart</button>
    </div>`;
  });
}

function renderAdmin() {
  if(!adminUnlocked) return;
  const list = document.getElementById('adminProductsList');
  list.innerHTML='';
  products.forEach((p,i)=>{
    list.innerHTML+=`
    <div class="flex items-center gap-4 p-4 rounded-xl shadow hover:shadow-lg transition bg-gray-50">
      <img src="${p.image}" class="w-24 h-24 object-cover rounded-lg">
      <div class="flex-1">
        <h4 class="font-semibold text-lg">${p.name}</h4>
        <p class="text-gray-600">Price: ${p.price} DH</p>
        <p class="text-gray-500 text-sm">Current / Total: ${p.stock} / ${p.capacity}</p>
        <p class="text-gray-500 text-sm">Production: ${p.production}</p>
        <p class="text-gray-500 text-sm">Expiration: ${p.expiration}</p>
      </div>
      <div class="flex flex-col gap-2">
        <button onclick='editProduct(${i})' class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition">Edit</button>
        <button onclick='deleteProduct(${i})' class="bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 transition">Delete</button>
      </div>
    </div>`;
  });
}

// Admin login
function loginAdmin(){
  if(adminPasswordInput.value === ADMIN_PASSWORD){
    adminUnlocked=true;
    adminPasswordInput.value='';
    loginError.classList.add('hidden');
    loginPage.classList.add('hidden');
    adminPage.classList.remove('hidden');
    renderAdmin();
  } else {
    loginError.classList.remove('hidden');
  }
}
function logoutAdmin(){ adminUnlocked=false; showShop(); }
function showLogin(){shopPage.classList.add('hidden'); checkoutPage.classList.add('hidden'); adminPage.classList.add('hidden'); loginPage.classList.remove('hidden');}
function showShop(){shopPage.classList.remove('hidden'); checkoutPage.classList.add('hidden'); adminPage.classList.add('hidden'); loginPage.classList.add('hidden');}

// Toggle password eye
togglePassword.addEventListener('click',()=>{
  if(adminPasswordInput.type==="password"){ adminPasswordInput.type="text"; togglePassword.textContent="üôà"; }
  else{ adminPasswordInput.type="password"; togglePassword.textContent="üëÅ"; }
});

// Products CRUD
async function saveProduct(){
  const i=editIndex.value;
  const data={
    name:pName.value, price:+pPrice.value, stock:+pStock.value, capacity:+pCapacity.value,
    production:pProduction.value, expiration:pExpiration.value, image:pImage.value
  };
  if(i===''){ const docRef=await addDoc(productsCollection,data); products.push({id:docRef.id,...data}); }
  else{ const docRef=doc(db,"products",products[i].id); await updateDoc(docRef,data); products[i]={id:products[i].id,...data}; }
  editIndex.value=''; pName.value=pPrice.value=pStock.value=pCapacity.value=pProduction.value=pExpiration.value=pImage.value='';
  renderProducts(); renderAdmin();
}
function editProduct(i){ const p=products[i]; pName.value=p.name; pPrice.value=p.price; pStock.value=p.stock; pCapacity.value=p.capacity; pProduction.value=p.production; pExpiration.value=p.expiration; pImage.value=p.image; editIndex.value=i; }
async function deleteProduct(i){ const docRef=doc(db,"products",products[i].id); await deleteDoc(docRef); products.splice(i,1); renderProducts(); renderAdmin(); }

// Cart
function addToCart(i){ if(products[i].stock<=0){alert("Out of stock"); return;} const c=cart.find(x=>x.i===i); if(c)c.q++; else cart.push({i,q:1}); products[i].stock--; updateCartCount(); renderCart(); renderProducts(); renderAdmin(); }
function renderCart(){ cartItems.innerHTML=''; let total=0; cart.forEach(c=>{ const p=products[c.i]; const l=p.price*c.q; total+=l; cartItems.innerHTML+=`<div class="flex items-center gap-3 border rounded-lg p-2 shadow-sm hover:shadow-md transition"><img src="${p.image}" class="w-16 h-16 object-cover rounded-lg"><div class="flex-1"><h4 class="font-semibold">${p.name}</h4><p class="text-sm text-gray-500">${c.q} x ${p.price} DH</p></div><div class="font-semibold">${l} DH</div></div>`; }); cartTotal.innerText=total+' DH'; }
function updateCartCount(){cartCount.innerText=cart.reduce((a,b)=>a+b.q,0);}
function openCart(){cartPanel.classList.remove('translate-x-full'); renderCart();}
function closeCart(){cartPanel.classList.add('translate-x-full');}
function checkout(){closeCart(); shopPage.classList.add('hidden'); checkoutPage.classList.remove('hidden');}
function confirmOrder(){alert('‚úÖ Order confirmed!'); cart=[]; renderProducts(); renderAdmin(); updateCartCount(); showShop();}

// Floating effect
function initFloatingEffect(){ document.querySelectorAll('.product-card').forEach(card=>{ card.addEventListener('mousemove',e=>{ const rect=card.getBoundingClientRect(); const x=e.clientX-(rect.left+rect.width/2); const y=e.clientY-(rect.top+rect.height/2); card.style.transform=`rotateY(${x*0.05}deg) rotateX(${-y*0.05}deg)`; }); card.addEventListener('mouseleave',()=>card.style.transform='rotateY(0deg) rotateX(0deg)'); }); }

loadProducts();
</script>
</body>
</html>
