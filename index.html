<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oubrou Market</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
.product-card { transition: all 0.3s ease; cursor: pointer; }
.product-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 12px 30px rgba(0,0,0,0.2); }
.out-of-stock { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center; font-weight:bold; color:#ef4444; font-size:1.2rem; border-radius:0.5rem; }
</style>
</head>
<body class="bg-gray-100 font-sans">

<!-- HEADER -->
<header class="bg-white shadow-md sticky top-0 z-50">
  <div class="container mx-auto flex justify-between items-center p-4">
    <h1 class="text-2xl font-bold text-indigo-600">üõí Oubrou Market</h1>
    <div class="flex items-center gap-3">
      <button onclick="openCart()" class="relative bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 transition">
        Cart <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">0</span>
      </button>
      <button onclick="openAdminLogin()" class="bg-gray-100 px-4 py-2 rounded shadow hover:bg-gray-200 transition">Admin</button>
    </div>
  </div>
</header>

<!-- SHOP -->
<section id="shop" class="container mx-auto p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></section>

<!-- CART PANEL -->
<div id="cartBox" class="fixed top-0 right-0 w-96 h-full bg-white shadow-xl p-6 hidden z-50 flex flex-col transition-transform">
  <h2 class="text-xl font-bold mb-4">Your Cart</h2>
  <div id="cartItems" class="flex-1 overflow-y-auto space-y-3"></div>
  <p class="font-bold mt-4 text-lg">Total: <span id="cartTotal">0</span> DH</p>
  <button onclick="openCheckout()" class="mt-4 w-full bg-green-600 text-white py-2 rounded shadow hover:bg-green-700 transition">Checkout</button>
  <button onclick="closeCart()" class="mt-2 w-full bg-red-500 text-white py-2 rounded shadow hover:bg-red-600 transition">Close</button>
</div>

<!-- CHECKOUT MODAL -->
<div id="checkoutBox" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg w-96 max-h-[90vh] overflow-auto shadow-lg">
    <h2 class="text-xl font-bold mb-4">Checkout</h2>
    <div id="checkoutItems" class="space-y-2 mb-4"></div>
    <p class="font-bold text-lg">Total: <span id="checkoutTotal">0</span> DH</p>
    <input id="customerName" type="text" placeholder="Full Name" class="border p-2 w-full rounded mt-2">
    <input id="customerPhone" type="text" placeholder="Phone" class="border p-2 w-full rounded mt-2">
    <input id="customerAddress" type="text" placeholder="Address" class="border p-2 w-full rounded mt-2">
    <button onclick="confirmOrder()" class="mt-4 w-full bg-green-600 text-white py-2 rounded shadow hover:bg-green-700 transition">Confirm Order</button>
    <button onclick="closeCheckout()" class="mt-2 w-full bg-red-500 text-white py-2 rounded shadow hover:bg-red-600 transition">Cancel</button>
  </div>
</div>

<!-- ADMIN LOGIN -->
<div id="adminLogin" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg w-80 shadow-lg">
    <h2 class="font-bold text-lg mb-3">Admin Login</h2>
    <div class="relative">
      <input id="adminPassword" type="password" class="border w-full p-2 rounded" placeholder="Password">
      <button onclick="togglePassword()" class="absolute right-2 top-2">üëÅ</button>
    </div>
    <button onclick="loginAdmin()" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded shadow hover:bg-indigo-700 transition">Login</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="fixed inset-0 bg-white hidden p-6 overflow-auto z-50">
  <button onclick="closeAdmin()" class="text-red-500 mb-4">‚Üê Exit</button>
  <h2 class="text-2xl font-bold mb-6">Admin Panel</h2>

  <!-- ADD PRODUCT -->
  <div class="max-w-md space-y-3 mb-6 p-4 bg-gray-50 rounded shadow">
    <input id="pName" class="border p-2 w-full rounded" placeholder="Product Name">
    <input id="pPrice" type="number" class="border p-2 w-full rounded" placeholder="Price">
    <input id="pTotal" type="number" class="border p-2 w-full rounded" placeholder="Total Capacity">
    <input id="pCurrent" type="number" class="border p-2 w-full rounded" placeholder="Current Capacity">
    <input id="pImage" class="border p-2 w-full rounded" placeholder="Image URL">
    <input id="pProdDate" type="date" class="border p-2 w-full rounded" placeholder="Production Date">
    <input id="pExpDate" type="date" class="border p-2 w-full rounded" placeholder="Expiration Date">
    <button onclick="addProduct()" class="bg-green-600 text-white py-2 w-full rounded shadow hover:bg-green-700 transition">Add Product</button>
  </div>

  <!-- PRODUCT LIST -->
  <h3 class="font-bold text-lg mb-2">Products</h3>
  <div id="adminList" class="space-y-2"></div>
</div>

<script>
// ================= SUPABASE KEYS =================
const SUPABASE_URL = "https://qzozwhxbzmldevbwdpep.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6b3p3aHhiemxkZXZid2RlcHciLCJyb2xlIjoiYW5vbiIsImlhdCI6MTc2Nzg5MzkzOCwiZXhwIjoyMDgzNDY5OTM4fQ.3ze6Wi1soRWTjLMiZBdG9gNUtX0_LORzlwmJctntJyQ";
const SUPABASE_API_KEY = "sb_publishable_iIF7Z6L7k7eF9yG1D9ozyA_onC8ylLT";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ================= DOM =================
const shop = document.getElementById("shop");
const cartBox = document.getElementById("cartBox");
const checkoutBox = document.getElementById("checkoutBox");
const cartItems = document.getElementById("cartItems");
const cartCount = document.getElementById("cartCount");
const cartTotal = document.getElementById("cartTotal");
const checkoutItems = document.getElementById("checkoutItems");
const checkoutTotal = document.getElementById("checkoutTotal");
const adminLogin = document.getElementById("adminLogin");
const adminPanel = document.getElementById("adminPanel");
const adminPassword = document.getElementById("adminPassword");
const adminList = document.getElementById("adminList");
const pName = document.getElementById("pName");
const pPrice = document.getElementById("pPrice");
const pTotal = document.getElementById("pTotal");
const pCurrent = document.getElementById("pCurrent");
const pImage = document.getElementById("pImage");
const pProdDate = document.getElementById("pProdDate");
const pExpDate = document.getElementById("pExpDate");
const customerName = document.getElementById("customerName");
const customerPhone = document.getElementById("customerPhone");
const customerAddress = document.getElementById("customerAddress");

// ================= DATA =================
let products = [];
let cart = [];

// ================= LOAD PRODUCTS =================
async function loadProducts() {
  const { data, error } = await supabase.from("products").select("*").order("id");
  if(error){ alert(error.message); return; }
  products = data;
  renderShop();
  renderAdmin();
}

// ================= RENDER SHOP =================
function renderShop() {
  shop.innerHTML = "";
  products.forEach((p,i)=>{
    const overlay = p.current_capacity <= 0 ? `<div class="out-of-stock">Out of Stock</div>` : "";
    shop.innerHTML += `
    <div class="product-card relative bg-white p-4 rounded shadow">
      <img src="${p.image}" class="h-48 w-full object-cover rounded">
      ${overlay}
      <h3 class="font-bold mt-2 text-lg">${p.name}</h3>
      <p class="text-indigo-600 font-semibold">${p.price} DH</p>
      <p class="text-gray-500 text-sm">Stock: ${p.current_capacity}/${p.total_capacity}</p>
      <p class="text-gray-400 text-xs">Prod: ${p.production_date||"-"} | Exp: ${p.expiration_date||"-"}</p>
      <button onclick="addToCart(${i})" class="mt-3 w-full bg-indigo-600 text-white py-2 rounded shadow hover:bg-indigo-700 transition">Add to cart</button>
    </div>`;
  });
}

// ================= CART WITH QUANTITY =================
function addToCart(i){
  const p = products[i];
  const cartItem = cart.find(item => item.id === p.id);
  
  if(cartItem){
    if(cartItem.quantity < p.current_capacity){
      cartItem.quantity++;
      p.current_capacity--;
    } else {
      alert("No more stock available!");
      return;
    }
  } else {
    if(p.current_capacity <= 0){ alert("Out of stock!"); return; }
    cart.push({...p, quantity: 1});
    p.current_capacity--;
  }
  
  cartCount.innerText = cart.reduce((sum,item)=>sum+item.quantity,0);
  renderCart();
  renderShop();
}

function renderCart(){
  cartItems.innerHTML = "";
  let total = 0;
  
  cart.forEach((item, index)=>{
    total += item.price * item.quantity;
    cartItems.innerHTML += `
      <div class="flex gap-3 items-center border-b pb-2">
        <img src="${item.image}" class="h-12 w-12 object-cover rounded">
        <div class="flex-1">
          <div class="font-semibold">${item.name}</div>
          <div class="flex items-center gap-2 mt-1">
            <button onclick="updateQuantity(${index}, -1)" class="bg-gray-200 px-2 rounded">-</button>
            <span>${item.quantity}</span>
            <button onclick="updateQuantity(${index}, 1)" class="bg-gray-200 px-2 rounded">+</button>
          </div>
        </div>
        <span>${(item.price * item.quantity).toFixed(2)} DH</span>
        <button onclick="removeItem(${index})" class="text-red-500 ml-2">x</button>
      </div>`;
  });
  
  cartTotal.innerText = total.toFixed(2);
}

function updateQuantity(index, change){
  const item = cart[index];
  const product = products.find(p => p.id === item.id);
  
  if(change === 1){
    if(product.current_capacity <= 0){ alert("No more stock!"); return; }
    item.quantity++;
    product.current_capacity--;
  } else {
    if(item.quantity <= 1){ removeItem(index); return; }
    item.quantity--;
    product.current_capacity++;
  }
  
  cartCount.innerText = cart.reduce((sum,i)=>sum+i.quantity,0);
  renderCart();
  renderShop();
}

function removeItem(index){
  const item = cart[index];
  const product = products.find(p => p.id === item.id);
  product.current_capacity += item.quantity;
  cart.splice(index, 1);
  
  cartCount.innerText = cart.reduce((sum,i)=>sum+i.quantity,0);
  renderCart();
  renderShop();
}

// ================= CHECKOUT =================
function openCheckout(){
  if(cart.length===0){ alert("Cart is empty"); return; }
  checkoutBox.classList.remove("hidden");
  checkoutItems.innerHTML = "";
  let total = 0;
  
  cart.forEach(item=>{
    total += item.price * item.quantity;
    checkoutItems.innerHTML += `
      <div class="flex gap-3 items-center border-b pb-2">
        <img src="${item.image}" class="h-12 w-12 object-cover rounded">
        <span>${item.name} x${item.quantity}</span>
        <span>${(item.price * item.quantity).toFixed(2)} DH</span>
      </div>`;
  });
  
  checkoutTotal.innerText = total.toFixed(2);
}

async function confirmOrder(){
  const name = customerName.value, phone = customerPhone.value, address = customerAddress.value;
  if(!name || !phone || !address){ alert("Fill all fields"); return; }
  
  const items = cart.map(p=>({id:p.id,name:p.name,price:p.price,quantity:p.quantity}));
  const total = cart.reduce((a,b)=>a+b.price*b.quantity,0);
  
  const { error } = await supabase.from("orders").insert([{customer_name:name,phone,address,items,total}]);
  if(error){ alert(error.message); return; }
  
  cart = [];
  cartCount.innerText = 0;
  renderCart();
  closeCheckout();
  customerName.value = customerPhone.value = customerAddress.value = "";
  alert("Order confirmed! Thank you.");
}

// ================= ADMIN =================
function openAdminLogin(){ adminLogin.classList.remove("hidden"); }
function togglePassword(){ adminPassword.type=adminPassword.type==="password"?"text":"password"; }
function loginAdmin(){
  if(adminPassword.value==="Oubrou12345"){
    adminLogin.classList.add("hidden");
    adminPanel.classList.remove("hidden");
  }else alert("Wrong password");
}
function closeAdmin(){ adminPanel.classList.add("hidden"); }

async function addProduct(){
  const {error} = await supabase.from("products").insert([{
    name:pName.value, price:Number(pPrice.value), total_capacity:Number(pTotal.value),
    current_capacity:Number(pCurrent.value), image:pImage.value||"https://via.placeholder.com/300",
    production_date:pProdDate.value||null, expiration_date:pExpDate.value||null
  }]);
  if(error){ alert(error.message); return; }
  pName.value=pPrice.value=pTotal.value=pCurrent.value=pImage.value=pProdDate.value=pExpDate.value="";
  loadProducts();
}

async function deleteProduct(id){
  const { error } = await supabase.from("products").delete().eq("id",id);
  if(error){ alert(error.message); return; }
  loadProducts();
}

// ================= INIT =================
loadProducts();
</script>
</body>
</html>
