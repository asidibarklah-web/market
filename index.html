<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oubrou Market</title>

<script src="https://cdn.tailwindcss.com"></script>

<!-- SUPABASE CDN (CORRECT) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
.card {
  transition: transform .3s ease, box-shadow .3s ease;
}
.card:hover {
  transform: translateY(-8px) scale(1.03);
  box-shadow: 0 20px 40px rgba(0,0,0,.2);
}
</style>
</head>

<body class="bg-gray-100">

<header class="bg-white shadow p-4 flex justify-between items-center">
  <h1 class="font-bold text-xl">üè™ Oubrou Market</h1>
  <div class="flex gap-4">
    <button onclick="showShop()">Shop</button>
    <button onclick="showLogin()">Admin</button>
    <button onclick="openCart()">üõí <span id="cartCount">0</span></button>
  </div>
</header>

<!-- SHOP -->
<section id="shop" class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6"></section>

<!-- LOGIN -->
<section id="login" class="hidden p-6 max-w-sm mx-auto">
  <h2 class="text-xl font-bold mb-4">Admin Login</h2>
  <div class="relative">
    <input id="adminPass" type="password" class="border p-2 w-full">
    <button onclick="togglePass()" class="absolute right-2 top-2">üëÅ</button>
  </div>
  <p id="err" class="text-red-600 hidden mt-2">Wrong password</p>
  <button onclick="login()" class="mt-4 w-full bg-indigo-600 text-white p-2 rounded">Enter</button>
</section>

<!-- ADMIN -->
<section id="admin" class="hidden p-6 max-w-4xl mx-auto">
  <h2 class="text-2xl font-bold mb-4">Admin Panel</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <input id="name" placeholder="Name" class="border p-2">
    <input id="price" type="number" placeholder="Price" class="border p-2">
    <input id="stock" type="number" placeholder="Current Stock" class="border p-2">
    <input id="capacity" type="number" placeholder="Total Capacity" class="border p-2">
    <input id="image" placeholder="Image URL" class="border p-2">
    <button onclick="saveProduct()" class="bg-green-600 text-white p-2 rounded">Save Product</button>
  </div>

  <div id="adminList" class="space-y-3"></div>
</section>

<!-- CART -->
<div id="cart" class="hidden fixed right-0 top-0 h-full w-80 bg-white shadow p-4">
  <h2 class="font-bold text-xl mb-4">Cart</h2>
  <div id="cartItems"></div>
  <p class="font-bold mt-4">Total: <span id="total">0</span> DH</p>
  <button onclick="closeCart()" class="mt-4 bg-red-600 text-white p-2 w-full rounded">Close</button>
</div>

<script>
/* üîó SUPABASE SETUP (CORRECT) */
const supabaseClient = supabase.createClient(
  "https://qzozwhxbzmldevbwdpep.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6b3p3aHhiem1sZGV2YndkcGVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4OTM5MzgsImV4cCI6MjA4MzQ2OTkzOH0.3ze6Wi1soRWTjLMiZBdG9gNUtX0_LORzlwmJctntJyQ"
);

let products = [];
let cart = [];
const ADMIN_PASSWORD = "Oubrou12345";

/* LOAD PRODUCTS */
async function loadProducts() {
  const { data, error } = await supabaseClient.from("products").select("*");
  if(error) { console.error(error); return; }
  products = data;
  renderShop();
  renderAdmin();
}
loadProducts();

/* SHOP */
function renderShop() {
  shop.innerHTML = "";
  products.forEach(p => {
    shop.innerHTML += `
      <div class="card bg-white p-4 rounded">
        <img src="${p.image}" class="h-40 mx-auto mb-2">
        <h3 class="font-bold">${p.name}</h3>
        <p>${p.price} DH</p>
        <p class="text-sm text-gray-500">${p.stock}/${p.capacity}</p>
        <button onclick="addToCart(${p.id})" class="mt-2 bg-indigo-600 text-white p-2 w-full rounded">Add</button>
      </div>
    `;
  });
}

/* ADMIN */
function renderAdmin() {
  adminList.innerHTML = "";
  products.forEach(p => {
    adminList.innerHTML += `
      <div class="bg-white p-3 rounded shadow flex justify-between">
        <span>${p.name}</span>
        <button onclick="remove(${p.id})" class="text-red-600">Delete</button>
      </div>
    `;
  });
}

async function saveProduct() {
  const data = {
    name: name.value,
    price: +price.value,
    stock: +stock.value,
    capacity: +capacity.value,
    image: image.value
  };
  const { error } = await supabaseClient.from("products").insert([data]);
  if(error){ alert("Save failed"); console.error(error); return; }
  loadProducts();
}

/* CART */
function addToCart(id){
  cart.push(products.find(p=>p.id===id));
  cartCount.innerText = cart.length;
}

function openCart(){ cart.classList.remove("hidden"); renderCart(); }
function closeCart(){ cart.classList.add("hidden"); }

function renderCart(){
  cartItems.innerHTML="";
  let t=0;
  cart.forEach(p=>{
    t+=p.price;
    cartItems.innerHTML+=`<p>${p.name} - ${p.price} DH</p>`;
  });
  total.innerText=t;
}

/* ADMIN LOGIN */
function login(){
  if(adminPass.value===ADMIN_PASSWORD){
    login.classList.add("hidden");
    admin.classList.remove("hidden");
  } else err.classList.remove("hidden");
}

function togglePass(){
  adminPass.type = adminPass.type==="password"?"text":"password";
}

function showLogin(){ shop.classList.add("hidden"); login.classList.remove("hidden"); }
function showShop(){ login.classList.add("hidden"); admin.classList.add("hidden"); shop.classList.remove("hidden"); }
</script>
</body>
</html>
